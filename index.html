<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Tareas Retro con Supabase</title>
    
    <script>
        // Este bloque simula un archivo .env.
        // Pega aquí tu URL y tu clave anónima de Supabase.
        const SUPABASE_CONFIG = {
            URL: 'https://eysgmubmkxjxaskxbvum.supabase.co',
            ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5c2dtdWJta3hqeGFza3hidnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDYwNTMsImV4cCI6MjA2NjMyMjA1M30.I3p0aZ9iZ-VaXRR8dDmAnxdXPEIkUbkoji95oGopzuM'
        };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Custom styles for the Stardew Valley retro aesthetic */
        body {
            font-family: 'VT323', monospace;
            background-color: #6b4a39; /* Woody brown background */
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAIAAACRXR/mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVRYw+3WMQoAIAgE0Pz/06ssg3SQuYFE31m4YUKyVqt9KCIiUp22tQ/2BLsD8hHi4fM7q939/w8QzxAPMR/R02GMMYbD4bDZbG5ubtbr9b7vRURE5PNn22tJ1Gg0c7jc7/f/APEQ8xDxEPFQezy+rNvtFrPZTMYyRkRk5CHiYeIh4mHiIeIh4qHyLsusVqvZbLlcLpVKpVIppZQyxgGxUURENBr9APpGq9tL7gAAAABJRU5ErkJggg==');
            color: #fff9e5; /* Creamy white text */
            image-rendering: pixelated;
        }

        #app-container {
            background-color: #4a3023; /* Darker wood color */
            border: 4px solid #ab856f; /* Lighter wood border */
            box-shadow: 8px 8px 0px #332117; /* Hard pixel shadow */
            border-radius: 8px;
        }
        
        #task-input {
            background-color: #332117;
            border: 2px solid #ab856f;
            border-radius: 0;
            padding: 10px;
            font-size: 1.25rem;
            color: #fff9e5;
        }

        #task-input::placeholder {
            color: #7d6a5a;
        }

        #task-input:focus {
            outline: none;
            border-color: #d9a169;
        }
        
        .retro-btn {
            background-color: #7a9e5a; /* Muted green */
            border: 2px solid #332117;
            box-shadow: 4px 4px 0px #332117;
            color: #fff9e5;
            transition: all 0.1s ease-in-out;
            border-radius: 0;
            font-size: 1.25rem;
            padding: 10px 16px;
        }

        .retro-btn:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #5c3d2e;
            border: 2px solid #7d6a5a;
            padding: 12px;
            border-radius: 0;
        }

        .custom-checkbox {
            -webkit-appearance: none;
            appearance: none;
            background-color: #332117;
            margin-right: 12px;
            width: 24px;
            height: 24px;
            border: 2px solid #ab856f;
            border-radius: 0;
            cursor: pointer;
            display: grid;
            place-content: center;
            flex-shrink: 0;
        }

        .custom-checkbox::before {
            content: "";
            width: 14px;
            height: 14px;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: #d9a169; /* Gold color */
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        .task-text {
            font-size: 1.5rem; /* Larger pixel text */
            line-height: 1.1;
            /* Allow text to wrap */
            word-break: break-word;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #7d6a5a;
        }

        .delete-btn {
            color: #ab856f;
            font-size: 1.5rem;
            padding-left: 1rem;
        }
        .delete-btn:hover {
            color: #d9a169;
        }
        
        /* Mobile responsive styles */
        @media screen and (max-width: 480px) {
            #app-container {
                padding: 1rem;
                box-shadow: 4px 4px 0px #332117;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }

            h1 {
                font-size: 2.5rem;
            }

            .task-text {
                font-size: 1.25rem;
            }
            
            #task-input, .retro-btn {
                font-size: 1.1rem;
                padding: 8px 12px;
            }
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    
    <div id="loading-spinner" class="text-2xl" style="color: #fff9e5;">Cargando tus tareas...</div>

    <div id="app-container" class="hidden w-full max-w-lg mx-auto p-6">
        
        <header class="text-center mb-6">
            <h1 class="text-5xl mb-2">Mi Planificador</h1>
            <p style="color: #ab856f;">¡Un día productivo te espera!</p>
        </header>

        <form id="add-task-form" class="flex items-center gap-3 mb-6">
            <input type="text" id="task-input" placeholder="Nueva tarea..." class="flex-grow w-full" required>
            <button type="submit" class="retro-btn">
                Añadir
            </button>
        </form>

        <div id="task-list" class="space-y-3">
            </div>

        <div id="user-info" class="text-center mt-6 text-xs" style="color: #7d6a5a;"></div>
    </div>

    <script>
        // --- Supabase Initialization ---
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const addTaskForm = document.getElementById('add-task-form');
        const taskInput = document.getElementById('task-input');
        const taskList = document.getElementById('task-list');
        const userInfo = document.getElementById('user-info');
        
        let currentUser = null;
        let localTasks = []; // Local cache for tasks

        // --- Authentication ---
        async function authenticateUser() {
            const { data: { session } } = await _supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
            } else {
                 const { data, error } = await _supabase.auth.signInAnonymously();
                 if(error) {
                     console.error("Error signing in anonymously:", error);
                     loadingSpinner.textContent = 'Falló la autenticación. Revisa la consola (F12).';
                     return;
                 }
                 currentUser = data.user;
            }
            
            if (currentUser) {
                userInfo.textContent = `ID de Usuario: ${currentUser.id}`;
                appContainer.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                await fetchInitialTasks();
                listenForChanges();
            }
        }

        // --- Render Tasks to the DOM ---
        function renderTasks() {
            // Sort tasks: incomplete first, then by creation time
            localTasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            taskList.innerHTML = ''; // Clear the list
            if (localTasks.length === 0) {
                taskList.innerHTML = `<p class="text-center text-lg" style="color: #ab856f;">Aún no hay tareas. ¡Añade una!</p>`;
            } else {
                localTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task-item';
                    taskElement.dataset.id = task.id;

                    const isCompleted = task.completed ? 'completed' : '';
                    const isChecked = task.completed ? 'checked' : '';
                    
                    taskElement.innerHTML = `
                        <div class="flex items-center flex-grow min-w-0">
                            <input type="checkbox" class="custom-checkbox" ${isChecked}>
                            <p class="task-text ${isCompleted}">${escapeHTML(task.text)}</p>
                        </div>
                        <button class="delete-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    taskList.appendChild(taskElement);
                });
            }
        }

        // --- Supabase Data Functions ---
        
        // Fetch all tasks once on initial load
        async function fetchInitialTasks() {
            const { data, error } = await _supabase.from('tasks').select('*');
            if (error) {
                console.error('Error fetching tasks:', error);
            } else {
                localTasks = data;
                renderTasks();
            }
        }
        
        // Listen for real-time changes
        function listenForChanges() {
            _supabase.channel('public:tasks')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                    console.log('Change received!', payload);
                    
                    switch(payload.eventType) {
                        case 'INSERT':
                            localTasks.push(payload.new);
                            break;
                        case 'UPDATE':
                            const indexToUpdate = localTasks.findIndex(t => t.id === payload.new.id);
                            if (indexToUpdate > -1) {
                                localTasks[indexToUpdate] = payload.new;
                            }
                            break;
                        case 'DELETE':
                            localTasks = localTasks.filter(t => t.id !== payload.old.id);
                            break;
                    }
                    renderTasks();
                })
                .subscribe();
        }
        
        // --- Event Handlers ---
        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskText = taskInput.value.trim();
            if (taskText && currentUser) {
                // Temporarily disable the form to prevent double submission
                taskInput.disabled = true;
                const submitButton = addTaskForm.querySelector('button');
                submitButton.disabled = true;

                const { error } = await _supabase.from('tasks').insert({ 
                    text: taskText, 
                    user_id: currentUser.id 
                });

                // Re-enable the form
                taskInput.disabled = false;
                submitButton.disabled = false;
                
                if (error) {
                    console.error("Error adding task: ", error);
                } else {
                    taskInput.value = ''; // Clear input field
                    taskInput.focus();
                }
            }
        });

        taskList.addEventListener('click', async (e) => {
            const taskElement = e.target.closest('[data-id]');
            if (!taskElement) return;
            const taskId = taskElement.dataset.id;
            
            // Handle checkbox click
            if (e.target.matches('.custom-checkbox')) {
                const isCompleted = e.target.checked;
                const { error } = await _supabase
                    .from('tasks')
                    .update({ completed: isCompleted })
                    .eq('id', taskId);
                if (error) console.error("Error updating task: ", error);
            }

            // Handle delete button click
            if (e.target.matches('.delete-btn, .delete-btn *')) {
                const { error } = await _supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);
                if (error) console.error("Error deleting task: ", error);
            }
        });

        // --- Utility ---
        function escapeHTML(str) {
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str));
            return p.innerHTML;
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!SUPABASE_CONFIG || !SUPABASE_CONFIG.URL || !SUPABASE_CONFIG.ANON_KEY) {
                loadingSpinner.textContent = 'Error: Configura tus claves de Supabase en el objeto SUPABASE_CONFIG.';
                return;
            }
            authenticateUser();
        });

    </script>
</body>
</html>
